# PyInstaller and Self-Extracting Files

## Important Limitation

**PyInstaller cannot be used on self-extracting Python files that contain embedded binary payloads.**

## Why This Limitation Exists

When you run PyInstaller on a Python file, it needs to analyze the source code to determine dependencies and bundle everything into an executable. This process involves:

1. Reading the entire `.py` file
2. Parsing it as Python source code
3. Using `importlib.util.decode_source()` to decode the file as UTF-8

When a Python file has binary data appended to it (like our self-extracting assistant files), Python's parser encounters non-UTF-8 bytes and fails with:

```
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xf1 in position XXXX: invalid continuation byte
```

## What This Means for the Project

### Self-Extracting Assistant Files (✓ Recommended for Distribution)

The self-extracting `assistant-*.py` files generated by `builder.py`:
- ✓ Can be run directly with Python: `python assistant-windows-latest-py3.11.py`
- ✓ Contain the full RCC binary, robot, and environment
- ✓ Are self-contained and portable
- ✗ **Cannot** be processed by PyInstaller
- ✗ **Cannot** be converted to standalone .exe files while preserving the embedded payload

### Launcher.exe Files (Built from launcher.py)

The `RccLauncher.exe` file built by PyInstaller from `launcher.py`:
- ✓ Can be built successfully with PyInstaller
- ✓ Is a standalone Windows executable
- ✗ Does **NOT** contain the embedded payload
- ✗ Will fail with "No embedded payload found" when run without separate payload

## Solutions and Workarounds

### Option 1: Distribute Self-Extracting Python Files (Recommended)

The self-extracting `.py` files are the intended distribution format:
- They work on any platform with Python installed
- They are self-contained with all dependencies
- Users just run: `python assistant-<platform>.py`

### Option 2: Use Alternative Packaging for .exe

If you need a Windows .exe, consider these alternatives:

1. **Use the launcher.py with external payload**
   - Build RccLauncher.exe from launcher.py
   - Distribute it alongside the payload ZIP file
   - Modify launcher to look for external payload file

2. **Use py2exe or cx_Freeze instead of PyInstaller**
   - These tools may have different parsing behavior
   - Test thoroughly before using in production

3. **Base64-encode the payload**
   - Encode binary payload as base64 text
   - Include it as a Python string in the source
   - This makes the file valid UTF-8 but increases size by ~33%

4. **NSIS or Inno Setup**
   - Create a traditional installer instead
   - Package the self-extracting .py file inside an installer
   - Users don't need Python installed

## Technical Details

### Why the Launcher Already Uses Binary Mode

The launcher.py file already follows best practices:

```python
# launcher.py correctly reads its own file in binary mode
def find_payload_offset(script_path):
    with open(script_path, "rb") as f:
        content = f.read()
    marker_pos = content.rfind(PAYLOAD_MARKER)
    # ...
```

This prevents UTF-8 decoding errors **at runtime** when the assistant runs. However, it doesn't prevent errors when **external tools** like PyInstaller try to analyze the file.

### Why We Can't Fix This in the Launcher

The launcher code cannot prevent external tools from trying to parse the file. When PyInstaller runs:

1. PyInstaller reads the file to analyze it
2. PyInstaller's code calls `importlib.util.decode_source(file_contents)`
3. This happens **before** any launcher code runs
4. The error occurs in PyInstaller's code, not ours

## References

- [PEP 263 - Defining Python Source Code Encodings](https://peps.python.org/pep-0263/)
- [PyInstaller Documentation](https://pyinstaller.org/)
- [Python importlib.util.decode_source](https://docs.python.org/3/library/importlib.html#importlib.util.decode_source)

## Summary

**For distribution**: Use the self-extracting `.py` files from the `build-assistant` job.

**For .exe files**: Consider alternative packaging methods or distribute the launcher.py-based .exe with an external payload file.
