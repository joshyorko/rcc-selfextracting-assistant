name: Build Self-Extracting RCC Assistant

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      robot_repo:
        description: 'Robot repository URL (e.g., https://github.com/joshyorko/fetch-repos-bot)'
        required: false
        default: 'https://github.com/joshyorko/fetch-repos-bot'
      rcc_version:
        description: 'RCC version or fork URL'
        required: false
        default: 'latest'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run test suite
        run: python test_build.py

  build-assistant:
    name: Build Self-Extracting Assistant
    needs: test
    permissions:
      contents: read
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download RCC
        shell: bash
        run: |
          echo "Downloading RCC..."
          if [ "$RUNNER_OS" == "Windows" ]; then
            curl -L https://downloads.robocorp.com/rcc/releases/latest/windows64/rcc.exe -o rcc.exe
            chmod +x rcc.exe
          elif [ "$RUNNER_OS" == "macOS" ]; then
            curl -L https://downloads.robocorp.com/rcc/releases/latest/macos64/rcc -o rcc
            chmod +x rcc
          else
            curl -L https://downloads.robocorp.com/rcc/releases/latest/linux64/rcc -o rcc
            chmod +x rcc
          fi
          
          # Verify RCC works
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./rcc.exe version
          else
            ./rcc version
          fi

      - name: Clone robot repository
        run: |
          git clone ${{ github.event.inputs.robot_repo || 'https://github.com/joshyorko/fetch-repos-bot' }} robot-project

      - name: Setup RCC Home and Build Holotree
        id: rcc-home
        shell: bash
        run: |
          # Set up a controlled ROBOCORP_HOME for the build
          if [ "$RUNNER_OS" == "Windows" ]; then
            BUILD_RCC_HOME="$GITHUB_WORKSPACE/rcc_home_build"
          else
            BUILD_RCC_HOME="$GITHUB_WORKSPACE/rcc_home_build"
          fi
          
          mkdir -p "$BUILD_RCC_HOME"
          export ROBOCORP_HOME="$BUILD_RCC_HOME"
          
          echo "ROBOCORP_HOME set to: $ROBOCORP_HOME"
          echo "rcc_home=$BUILD_RCC_HOME" >> $GITHUB_OUTPUT
          
          # Build and materialize the Holotree environment
          echo "Building Holotree for offline execution..."
          echo "This will download and cache all dependencies..."
          
          if [ "$RUNNER_OS" == "Windows" ]; then
            # Use 'rcc run' with a dummy command to force full environment materialization
            export ROBOCORP_HOME="$BUILD_RCC_HOME"
            ./rcc.exe holotree variables robot-project/robot.yaml || true
            
            # Verify environment was created
            if [ -d "$BUILD_RCC_HOME" ]; then
              echo "Holotree created successfully"
              du -sh "$BUILD_RCC_HOME" 2>/dev/null || echo "Size unknown"
              find "$BUILD_RCC_HOME" -type f | wc -l || echo "File count unknown"
            else
              echo "Warning: Holotree directory not created"
            fi
          else
            # Unix-like systems
            export ROBOCORP_HOME="$BUILD_RCC_HOME"
            ./rcc holotree variables robot-project/robot.yaml || true
            
            # Verify environment was created
            if [ -d "$BUILD_RCC_HOME" ]; then
              echo "Holotree created successfully"
              du -sh "$BUILD_RCC_HOME"
              find "$BUILD_RCC_HOME" -type f | wc -l
            else
              echo "Warning: Holotree directory not created"
            fi
          fi

      - name: Build self-extracting assistant
        shell: bash
        run: |
          echo "Building self-extracting assistant..."
          
          # Determine RCC executable name
          if [ "$RUNNER_OS" == "Windows" ]; then
            RCC_EXE="rcc.exe"
          else
            RCC_EXE="rcc"
          fi
          
          # Build with or without RCC home
          if [ -d "${{ steps.rcc-home.outputs.rcc_home }}" ]; then
            python builder.py \
              --rcc "$RCC_EXE" \
              --rcc-home "${{ steps.rcc-home.outputs.rcc_home }}" \
              --robot robot-project \
              --output "assistant-${{ matrix.os }}-py${{ matrix.python-version }}.py"
          else
            echo "Building without RCC home (online mode)"
            python builder.py \
              --rcc "$RCC_EXE" \
              --robot robot-project \
              --output "assistant-${{ matrix.os }}-py${{ matrix.python-version }}.py"
          fi
          
          # Show result
          ls -lh assistant-*.py

      - name: Test self-extracting assistant (dry run)
        shell: bash
        run: |
          # Quick test - check that file has payload marker
          ASSISTANT_FILE="assistant-${{ matrix.os }}-py${{ matrix.python-version }}.py"
          
          if grep -q "===RCC_PAYLOAD_START===" "$ASSISTANT_FILE"; then
            echo "âœ“ Payload marker found in assistant"
          else
            echo "âœ— ERROR: Payload marker not found!"
            exit 1
          fi
          
          # Check file size (should be reasonably large with payload)
          SIZE=$(stat -c%s "$ASSISTANT_FILE" 2>/dev/null || stat -f%z "$ASSISTANT_FILE")
          echo "Assistant size: $SIZE bytes"
          
          if [ "$SIZE" -lt 10000 ]; then
            echo "âœ— ERROR: Assistant file too small, likely missing payload"
            exit 1
          fi
          
          echo "âœ“ Assistant file looks valid"

      - name: Upload assistant artifact
        uses: actions/upload-artifact@v4
        with:
          name: assistant-${{ matrix.os }}-py${{ matrix.python-version }}
          path: assistant-${{ matrix.os }}-py${{ matrix.python-version }}.py
          retention-days: 90
          if-no-files-found: error

  build-windows-exe:
    name: Build Windows .exe Bundle
    needs: build-assistant
    runs-on: windows-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build Windows .exe from launcher.py
        run: |
          echo "Building Windows executable from launcher.py..."
          echo ""
          echo "NOTE: PyInstaller cannot process self-extracting files with embedded"
          echo "binary payloads because it attempts to parse the entire file as UTF-8"
          echo "Python source code. Instead, we build an .exe from the original"
          echo "launcher.py, which can then be distributed without the binary payload."
          echo ""
          
          pyinstaller --onefile `
            --name "RccLauncher" `
            --icon "" `
            --console `
            launcher.py
          
          # Check result
          dir dist\

      - name: Test .exe (dry run)
        run: |
          # Just check that exe exists and has reasonable size
          if (Test-Path dist\RccLauncher.exe) {
            $size = (Get-Item dist\RccLauncher.exe).Length
            Write-Host "âœ“ EXE created, size: $size bytes"
            
            if ($size -lt 1MB) {
              Write-Host "âœ— WARNING: EXE seems too small"
            }
          } else {
            Write-Host "âœ— ERROR: EXE not created"
            exit 1
          }

      - name: Upload .exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: RccLauncher-windows-exe
          path: dist/RccLauncher.exe
          retention-days: 90
          
      - name: Explanation
        run: |
          echo ""
          echo "=================================="
          echo "Build Complete"
          echo "=================================="
          echo ""
          echo "The RccLauncher.exe is built from launcher.py WITHOUT the embedded payload."
          echo "This .exe can be used as a launcher that expects the payload to be provided"
          echo "separately or it will fail with 'No embedded payload found' error."
          echo ""
          echo "For distribution, use the self-extracting .py files from the"
          echo "'build-assistant' job artifacts instead. These contain the full payload"
          echo "and can be run with: python assistant-<platform>-py<version>.py"
          echo ""

  create-release:
    name: Create Release
    needs: [build-assistant, build-windows-exe]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write  # Needed to create releases and upload assets
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release archives
        run: |
          cd artifacts
          
          # Create archives for each platform
          for dir in */; do
            dirname="${dir%/}"
            echo "Creating archive for $dirname..."
            cd "$dirname"
            zip -r "../${dirname}.zip" .
            cd ..
          done
          
          ls -lh *.zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Build Summary
    needs: [build-assistant, build-windows-exe]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Built:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Self-extracting Python assistants (multiple OS/Python versions)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Windows .exe bundle (PyInstaller)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "Go to the **Actions** tab > This workflow run > **Artifacts** section" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'python assistant-<platform>-py<version>.py' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
